#!/usr/bin/env msh.local

AWS_SQS_URL=
read input;
#echo '{"StdinRef": "sqs", "StdoutRef": "sqs"}'; read config

stdin="$(echo $config|jq '.StdinRef')"
stdout="$(echo $config|jq '.StdoutRef')"

echo "stdin: $stdin" 1>&2


input="$(aws sqs receive-message --queue-url "$stdin" --wait-time-seconds 5)"
if [ -z "$input" ]; then
    echo "No msgs received from SQS"
fi

msg="$(
  aws sqs send-message \
    --queue-url "$stdout" \
    --message-body "$output"
)"

aws sqs delete-message \
  --queue-url "$stdin" \
  --receipt-handle "$(echo "$msg"| jq -r '.Messages[0].ReceiptHandle')" \
    1>/dev/null

echo "$msg" | jq -r '.Messages[0].Body'| sed 's/input/output/'
